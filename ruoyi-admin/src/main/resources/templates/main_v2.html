<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSR主页</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <meta name="apple-mobile-web-app-title" content="OSR"/>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/animate.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/style.min.css}" rel="stylesheet"/>
    <style>
        .chart-container {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            height: 100%;
        }

        .echarts {
            width: 100%;
            height: 250px;
            border-radius: 5px;
        }

        .chart-wrapper {
            position: relative;
            height: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chart-container select {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            font-size: 12px;
            padding: 2px 6px;
        }

        .chart-container strong {
            font-size: 14px;
            color: #333;
        }
    </style>
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content">
    <div class="row">
        <!-- COPY 图表 -->
        <div class="col-md-3">
            <div class="chart-container">
                <div class="chart-header">
                    <strong id="title-copy">COPY任务</strong>
                    <select onchange="updateChart('copy-pie-chart', 'openliststrm/copy/stats', this.value, 'copy')">
                        <option value="today" selected>今日</option>
                        <option value="yesterday">昨日</option>
                        <option value="all">全部</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <div class="echarts" id="copy-pie-chart"></div>
                </div>
            </div>
        </div>

        <!-- STRM 图表 -->
        <div class="col-md-3">
            <div class="chart-container">
                <div class="chart-header">
                    <strong id="title-strm">STRM任务</strong>
                    <select onchange="updateChart('strm-pie-chart', 'openliststrm/strm/stats', this.value, 'strm')">
                        <option value="today" selected>今日</option>
                        <option value="yesterday">昨日</option>
                        <option value="all">全部</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <div class="echarts" id="strm-pie-chart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: echarts-js"/>
<script th:inline="javascript"> var ctx = [[@{/}]]</script>
<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/ajax/libs/validate/jquery.validate.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:src="@{/ruoyi/js/ry-ui.js}"></script>

<script type="text/javascript">
    $(function () {
        updateChart('copy-pie-chart', 'openliststrm/copy/stats', 'today', 'copy');
        updateChart('strm-pie-chart', 'openliststrm/strm/stats', 'today', 'strm');

        $(window).on('resize', function () {
            echarts.getInstanceByDom(document.getElementById('copy-pie-chart'))?.resize();
            echarts.getInstanceByDom(document.getElementById('strm-pie-chart'))?.resize();
        });
    });

    function updateChart(elementId, url, range, type) {
        const chartDom = document.getElementById(elementId);
        let chart = echarts.getInstanceByDom(chartDom);
        if (!chart) {
            chart = echarts.init(chartDom);
        }

        const colorMap = {
            '成功': '#4BC0C0',
            '失败': '#FF6384',
            '未知': '#FFCE56',
            '处理中': '#36A2EB',
            '_default': ['#466dbd', '#50c295', '#b98f15', '#b44e36', '#6DC8EC', '#9270CA', '#FF9D4D', '#269A99']
        };

        function getColorForData(name) {
            if (colorMap[name]) return colorMap[name];
            const lower = name.toLowerCase();
            for (const key in colorMap) {
                if (key !== '_default' && lower.includes(key.toLowerCase())) {
                    return colorMap[key];
                }
            }
            const idx = Object.keys(colorMap).filter(k => k !== '_default').length;
            return colorMap._default[idx % colorMap._default.length];
        }

        const rangeTextMap = {
            today: '今日数据',
            yesterday: '昨日数据',
            all: '全部数据'
        };

        const fullTitle = rangeTextMap[range];

        $.ajax({
            url: ctx + url,
            type: "POST",
            data: {range: range},
            dataType: "json",
            success: function (res) {
                chart.clear();
                if (res.code === 0 && Object.keys(res.data).length > 0) {
                    const chartData = Object.entries(res.data).map(([name, value]) => ({
                        value: value,
                        name: name,
                        itemStyle: {color: getColorForData(name)}
                    }));

                    chart.setOption({
                        title: {
                            text: fullTitle,
                            left: 'left',
                            textStyle: {
                                fontSize: 12,
                                fontWeight: 'normal',
                                color: '#999'
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'right',
                            data: chartData.map(item => item.name)
                        },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 5,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{c}',
                                position: 'inside'
                            },
                            emphasis: {
                                label: {
                                    show: false
                                }
                            },
                            labelLine: {show: false},
                            minAngle: 5,
                            data: chartData
                        }]
                    });
                } else {
                    chart.setOption({
                        title: {
                            text: fullTitle,
                            left: 'left',
                            textStyle: {
                                fontSize: 12,
                                fontWeight: 'normal',
                                color: '#999'
                            }
                        },
                        graphic: {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: '暂无数据',
                                fontSize: 14,
                                fill: '#888'
                            }
                        },
                        series: []
                    });
                }
            },
            error: function (xhr, status, error) {
                $.modal.msgError("获取数据失败: " + (error || status));
                chart.setOption({
                    title: {
                        text: fullTitle,
                        left: 'left',
                        textStyle: {
                            fontSize: 12,
                            fontWeight: 'normal',
                            color: '#999'
                        }
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: '获取数据失败',
                            fontSize: 14,
                            fill: '#888'
                        }
                    },
                    series: []
                });
            }
        });
    }
</script>

</body>
</html>
